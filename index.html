<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D-Maths Live U.T.M.E Mock</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <script>
        window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] } };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        .active-q { border: 2px solid #1d4ed8; background-color: #dbeafe; }
        .answered-q { background-color: #10b981; color: white; }
    </style>
</head>
<body class="bg-gray-50 font-sans">

    <div id="landing-page" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full border-t-4 border-blue-700">
            <h1 class="text-3xl font-extrabold text-blue-800 mb-2 text-center">D-Maths Live</h1>
            <p class="text-center text-gray-600 mb-6 font-semibold">U.T.M.E Mathematics Mock</p>
            
            <form id="regForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-gray-700">Full Name</label>
                    <input type="text" id="userName" required class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700">Phone Number</label>
                    <input type="tel" id="userPhone" required class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700">Email Address</label>
                    <input type="email" id="userEmail" required class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div class="bg-blue-50 p-3 rounded text-xs text-blue-800 italic">
                    Note: Changing tabs or minimizing this browser during the exam will cause automatic submission.
                </div>
                <button type="submit" class="w-full bg-blue-700 text-white py-4 rounded-lg font-bold text-lg hover:bg-blue-800 transition shadow-lg">
                    LOG IN & START TEST
                </button>
            </form>
        </div>
    </div>

    <div id="exam-page" class="hidden min-h-screen flex flex-col">
        <header class="bg-white border-b p-4 flex justify-between items-center sticky top-0 z-10 shadow-sm">
            <div>
                <h2 class="text-xl font-bold text-blue-900">D-Maths Mock</h2>
                <p id="displayStudent" class="text-sm text-gray-500 font-medium"></p>
            </div>
            <div id="timer" class="text-2xl font-mono font-bold bg-red-100 text-red-600 px-6 py-2 rounded-full border-2 border-red-200">
                40:00
            </div>
        </header>

        <main class="flex-1 flex flex-col lg:flex-row p-4 gap-6 max-w-7xl mx-auto w-full">
            <div class="lg:w-2/3 bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <div class="flex items-center justify-between mb-6 border-b pb-4">
                    <span class="bg-blue-100 text-blue-700 font-bold px-4 py-1 rounded">Question <span id="qNumDisplay">1</span> of 40</span>
                </div>

                <div class="mb-8">
                    <p id="qText" class="text-xl text-gray-800 leading-relaxed mb-6 font-medium"></p>
                    <div id="qDiagram" class="flex justify-center mb-6"></div>
                </div>

                <div id="options-list" class="space-y-4"></div>

                <div class="mt-10 flex justify-between border-t pt-6">
                    <button onclick="changeQ(-1)" class="px-8 py-3 bg-gray-200 rounded-lg font-bold hover:bg-gray-300 transition">Previous</button>
                    <button onclick="changeQ(1)" class="px-8 py-3 bg-blue-700 text-white rounded-lg font-bold hover:bg-blue-800 transition">Next</button>
                </div>
            </div>

            <div class="lg:w-1/3 space-y-4">
                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="font-bold text-gray-700 mb-4 border-b pb-2">Question Navigation</h3>
                    <div id="nav-grid" class="grid grid-cols-5 md:grid-cols-8 lg:grid-cols-5 gap-2"></div>
                </div>
                <button onclick="handleManualSubmit()" class="w-full py-4 bg-green-600 text-white rounded-xl font-black text-xl hover:bg-green-700 transition shadow-xl">
                    FINISH & SUBMIT
                </button>
            </div>
        </main>
    </div>

    <script>
        /* --- CONFIGURATION --- */
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxaU1g2jL0Gk4B18AKN3OQGd3Kk0zgxx0h-D3iRW88C8IyyfIlkkgMhINORCIYEvXRF/exec"; 
        const TEST_TIME_MINS = 40;
        
        const questions = [
            {
                q: "If $log_{10} 2 = 0.3010$ and $log_{10} 3 = 0.4771$, evaluate $log_{10} 4.5$.",
                options: ["0.9542", "0.6532", "0.4771", "0.3010"],
                correct: 1
            },
            {
                q: "Simplify $\\frac{1}{\\sqrt{3} + \\sqrt{2}}$ by rationalizing the denominator.",
                options: ["$\\sqrt{3} + \\sqrt{2}$", "$\\sqrt{3} - \\sqrt{2}$", "$\\frac{\\sqrt{3} - \\sqrt{2}}{2}$", "1"],
                correct: 1
            },
            {
                q: "Convert $72_8$ to a number in base 3.",
                options: ["2010", "2100", "1111", "2022"],
                correct: 0
            },
            {
                q: "Find the amount on ₦4,000 for 2 years at 5% per annum compound interest.",
                options: ["₦4,410", "₦4,400", "₦4,200", "₦4,500"],
                correct: 0
            },
            {
                q: "If $(x - 1)$ is a factor of $px^3 + qx^2 + 1 = 0$, find the relationship between $p$ and $q$.",
                options: ["p + q = 1", "p + q = -1", "p - q = 1", "p = q"],
                correct: 1
            },
            {
                q: "Solve the inequality: $2x - 5 < 7$ and $3x + 2 > -4$.",
                options: ["-2 < x < 6", "x < 6", "x > -2", "-6 < x < 2"],
                correct: 0
            },
            {
                q: "Find the 10th term of the A.P: 2, 5, 8, 11...",
                options: ["27", "29", "30", "32"],
                correct: 1
            },
            {
                q: "If $y$ varies inversely as the square of $x$ and $y=4$ when $x=3$, find $y$ when $x=2$.",
                options: ["9", "6", "12", "18"],
                correct: 0
            },
            {
                q: "Make $t$ the subject of the formula: $K = w \\sqrt{\\frac{t-r}{t}}$.",
                options: ["$t = \\frac{wr}{w^2 - K^2}$", "$t = \\frac{w^2r}{w^2 - K^2}$", "$t = \\frac{Kr}{w-K}$", "$t = \\frac{r}{w-K}$"],
                correct: 1
            },
            {
                q: "In the diagram, O is the center of the circle. If $\\angle PQR = 75^{\\circ}$, find the interior $\\angle POR$.",
                options: ["150°", "100°", "75°", "37.5°"],
                correct: 0,
                diagram: "[Circle Geometry Diagram Placeholder]"
            },
            {
                q: "Calculate the total surface area of a cylinder of height 10cm and radius 7cm. (Take $\\pi = 22/7$)",
                options: ["440 cm²", "748 cm²", "308 cm²", "154 cm²"],
                correct: 1
            },
            {
                q: "The sum of the interior angles of a regular polygon is 1080°. Find the number of sides.",
                options: ["6", "7", "8", "10"],
                correct: 2
            },
            {
                q: "Find the gradient of the line joining the points (2, -3) and (-1, 4).",
                options: ["-7/3", "7/3", "-3/7", "3/7"],
                correct: 0
            },
            {
                q: "If $\\cos \\theta = 4/5$ and $\\theta$ is acute, find $\\tan \\theta$.",
                options: ["3/4", "3/5", "5/4", "4/3"],
                correct: 0
            },
            {
                q: "A ladder 6m long leans against a vertical wall. If it makes an angle of 60° with the floor, how high is the wall?",
                options: ["3m", "3√3 m", "6√3 m", "4m"],
                correct: 1,
                diagram: "[Trigonometry Ladder Diagram Placeholder]"
            },
            {
                q: "Differentiate $y = (2x + 3)^4$ with respect to $x$.",
                options: ["$4(2x+3)^3$", "$8(2x+3)^3$", "$2(2x+3)^3$", "8x+12"],
                correct: 1
            },
            {
                q: "Evaluate $\\int_1^2 (3x^2 - 2x) dx$.",
                options: ["2", "4", "6", "8"],
                correct: 1
            },
            {
                q: "Find the mean deviation of the sets of numbers: 10, 12, 14, 16, 18.",
                options: ["2.4", "0", "14", "3.2"],
                correct: 0
            },
            {
                q: "Two fair dice are thrown once. What is the probability of getting a total score of 7?",
                options: ["1/12", "1/6", "5/36", "1/4"],
                correct: 1
            },
            {
                q: "In a class of 50 students, 30 study Biology and 25 study Physics. If each student studies at least one subject, how many study both?",
                options: ["5", "10", "15", "20"],
                correct: 0
            }
            // Note: You can add 20 more here.
        ];

        let currentIdx = 0;
        let timeLeft = TEST_TIME_MINS * 60;
        let userAnswers = new Array(questions.length).fill(null);
        let userData = {};
        let isSubmitted = false;

        // 1. Tab Security
        document.addEventListener("visibilitychange", () => {
            if (document.hidden && !isSubmitted) {
                alert("SECURITY ALERT: Tab switching detected. Automatic submission triggered.");
                submitTest("Security Violation");
            }
        });

        // 2. Registration
        document.getElementById('regForm').addEventListener('submit', (e) => {
            e.preventDefault();
            userData = {
                name: document.getElementById('userName').value,
                number: document.getElementById('userPhone').value,
                email: document.getElementById('userEmail').value
            };
            document.getElementById('displayStudent').innerText = `Student: ${userData.name}`;
            document.getElementById('landing-page').classList.add('hidden');
            document.getElementById('exam-page').classList.remove('hidden');
            startTimer();
            renderQuestion();
            renderNav();
        });

        // 3. Timer
        function startTimer() {
            const timerEl = document.getElementById('timer');
            const countdown = setInterval(() => {
                let mins = Math.floor(timeLeft / 60);
                let secs = timeLeft % 60;
                timerEl.innerText = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
                if (timeLeft <= 0) {
                    clearInterval(countdown);
                    submitTest("Time Out");
                }
                timeLeft--;
            }, 1000);
        }

        // 4. CBT Rendering
        function renderQuestion() {
            const q = questions[currentIdx];
            document.getElementById('qNumDisplay').innerText = currentIdx + 1;
            document.getElementById('qText').innerHTML = q.q; // Changed to innerHTML for MathJax
            
            const diagDiv = document.getElementById('qDiagram');
            diagDiv.innerHTML = q.diagram ? `<div class="p-4 border-2 border-dashed rounded bg-gray-50 text-sm italic text-gray-500">${q.diagram}</div>` : '';

            const list = document.getElementById('options-list');
            list.innerHTML = '';
            q.options.forEach((opt, i) => {
                const isSelected = userAnswers[currentIdx] === i;
                const btn = document.createElement('button');
                btn.className = `w-full text-left p-4 border-2 rounded-xl transition font-medium flex items-center gap-4 ${isSelected ? 'border-blue-600 bg-blue-50 text-blue-800' : 'border-gray-100 hover:border-blue-200'}`;
                btn.innerHTML = `<span class="w-8 h-8 flex items-center justify-center rounded-full bg-white border font-bold">${String.fromCharCode(65+i)}</span> ${opt}`;
                btn.onclick = () => { userAnswers[currentIdx] = i; renderQuestion(); renderNav(); };
                list.appendChild(btn);
            });

            // Re-render MathJax for the new question content
            if (window.MathJax) MathJax.typeset();
        }

        function renderNav() {
            const grid = document.getElementById('nav-grid');
            grid.innerHTML = '';
            questions.forEach((_, i) => {
                const btn = document.createElement('button');
                btn.innerText = i + 1;
                btn.className = `h-10 w-full rounded font-bold text-sm transition ${currentIdx === i ? 'active-q' : ''} ${userAnswers[i] !== null ? 'answered-q' : 'bg-gray-100'}`;
                btn.onclick = () => { currentIdx = i; renderQuestion(); };
                grid.appendChild(btn);
            });
        }

        function changeQ(dir) {
            let next = currentIdx + dir;
            if (next >= 0 && next < questions.length) {
                currentIdx = next;
                renderQuestion();
                renderNav();
            }
        }

        // 5. Submission & PDF
        function handleManualSubmit() {
            if (confirm("Are you sure you want to end the test?")) submitTest("Manual");
        }

        async function submitTest(type = "Manual") {
            if (isSubmitted) return;
            isSubmitted = true;

            let score = 0;
            userAnswers.forEach((ans, i) => {
                if (ans === questions[i].correct) score++;
            });

            // 1. Sync to Google Sheets with added Submission Status
            fetch(WEB_APP_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ ...userData, score: score, submissionType: type })
            }).catch(e => console.error("Sheet Sync Error"));

            // 2. Generate PDF
            generatePDF(score);

            alert(`Test Submitted Successfully via ${type}!\nYour Score: ${score}/${questions.length}\nYour PDF result is downloading...`);
            location.reload();
        }

        async function generatePDF(score) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(22);
            doc.setTextColor(29, 78, 216);
            doc.text("D-Maths Live Result Sheet", 105, 20, { align: "center" });

            doc.setFontSize(12);
            doc.setTextColor(0,0,0);
            doc.text(`Candidate: ${userData.name}`, 20, 40);
            doc.text(`Score: ${score} / ${questions.length}`, 20, 50);
            
            const rows = questions.map((q, i) => [
                i + 1,
                userAnswers[i] !== null ? String.fromCharCode(65 + userAnswers[i]) : "-",
                String.fromCharCode(65 + q.correct),
                userAnswers[i] === q.correct ? "CORRECT" : "WRONG"
            ]);

            doc.autoTable({
                head: [['Qtn', 'Your Answer', 'Correct', 'Status']],
                body: rows,
                startY: 60,
                headStyles: { fillColor: [29, 78, 216] }
            });

            doc.save(`Result_${userData.name}.pdf`);
        }
    </script>
</body>
</html>
